{% extends "base.html" %}

{% block title %}Products - Trader CMS{% endblock %}
{% block page_title %}Products{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4 align-items-center">
        <div class="col-md-4">
            <h4>Your Products</h4>
            <p class="text-muted small mb-0">Manage your product catalog</p>
        </div>
        <div class="col-md-8 text-end">
            <a href="/products/browse" class="btn btn-primary">
                <i class="bi bi-search"></i> Browse & Add Products
            </a>
        </div>
    </div>

    {% if request.query_params.get('success') %}
    <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
        <i class="bi bi-check-circle me-1"></i> {{ request.query_params.get('success') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Filters -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="category-filter" class="form-label small fw-bold text-uppercase text-muted">Category</label>
                    <select class="form-select" id="category-filter" name="category_id">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if selected_category == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <span class="text-muted small">Showing {{ products|length }} of {{ total_count }} products</span>
                </div>
                <div class="col-md-2 d-flex align-items-end justify-content-end">
                    {% if selected_category %}
                    <a href="/products" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Reset
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="card border-0 shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40px;"><i class="bi bi-arrow-down-up text-muted"></i></th>
                        <th>Product Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="products-list">
                    {% if products %}
                        {% for product in products %}
                        <tr class="product-row" data-id="{{ product.id }}">
                            <td class="drag-handle cursor-grab">
                                <i class="bi bi-grip-vertical text-muted"></i>
                            </td>
                            <td>
                                <strong>{{ product.title }}</strong>
                                {% if product.local_description %}
                                <div class="small text-muted mt-1">{{ product.local_description[:50] }}...</div>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">{{ product.category_name }}</span>
                            </td>
                            <td>${{ product.price }}</td>
                            <td>
                                <small class="text-muted">{{ product.central_stock }} units</small>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary"
                                        hx-get="/products/{{ product.id }}/edit"
                                        hx-target="#modal-content"
                                        data-bs-toggle="modal"
                                        data-bs-target="#edit-modal">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted">
                            No products found. <a href="/products/browse">Browse & Add Products</a> to get started.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% include "includes/pagination.html" %}
</div>

<!-- Edit Modal -->
<div class="modal fade" id="edit-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="modal-content">
            <!-- Content loaded via HTMX -->
        </div>
    </div>
</div>

<script>
    // Category filter change handler
    document.getElementById('category-filter').addEventListener('change', function() {
        const categoryId = this.value;
        if (categoryId) {
            window.location.href = `/products?category_id=${categoryId}`;
        } else {
            window.location.href = '/products';
        }
    });

    // Sortable drag-drop
    const el = document.getElementById('products-list');
    if (el && typeof Sortable !== 'undefined') {
        new Sortable(el, {
            handle: '.drag-handle',
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function(evt) {
                const order = Array.from(document.querySelectorAll('.product-row')).map((el, idx) => ({
                    product_id: parseInt(el.dataset.id),
                    display_order: idx
                }));

                htmx.ajax('POST', '/api/v1/trader/products/reorder', {
                    values: {orders: JSON.stringify(order)}
                });
            }
        });
    } else if (el) {
        console.warn('Sortable library not loaded');
    }

    // Modal content
    document.getElementById('edit-modal').addEventListener('show.bs.modal', function(e) {
        const btn = e.relatedTarget;
        if (btn && btn.getAttribute('hx-get')) {
            htmx.ajax('GET', btn.getAttribute('hx-get'), {target: '#modal-content'});
        }
    });
</script>
{% endblock %}
